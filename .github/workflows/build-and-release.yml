name: Build and Release
on:
  push:
    paths-ignore:
      - 'docs/**'

env:
  NO_PRINT_PROGRESS: 1
  IGNITE: ./build/ignite

jobs:
  generate-cache:
    name: Generate cache
    runs-on: self-hosted
    timeout-minutes: 47000
    strategy:
      matrix:
        collection:
          - xfce4/desktop
          - xfce4/workstation
          - gnome/desktop
          - gnome/workstation
    steps:
      - uses: actions/checkout@v1

      - name: Configure
        run: |
          make

          VERSION=${GITHUB_REF#refs/*/}
          COLLECTION="${{matrix.collection}}"
          cat > version.yml << EOF
          version: "${VERSION}"
          variables:
            collection: "${{matrix.collection}}"
            ostree-branch: "${VERSION}/${{matrix.collection}}"
            installer-id: ${COLLECTION//\//-}
          EOF
          echo "VERSION=${VERSION}"   >> $GITHUB_ENV

      - name: Generate Cache
        run: ${IGNITE} build system/repo.yml


  update-repository:
    name: Update Repository
    runs-on: self-hosted
    timeout-minutes: 47000
    environment: RELEASE
    needs: generate-cache
    env:
      OSTREE_REPO: ${{ secrets.OSTREE_REPO }}
      OSTREE_GPG: ${{ secrets.OSTREE_GPG }}
    strategy:
      matrix:
        collection:
          - xfce4/desktop
          - xfce4/workstation
          - gnome/desktop
          - gnome/workstation
    steps:
      - uses: actions/checkout@v1

      - name: Configure
        run: |
          make

          VERSION=${GITHUB_REF#refs/*/}
          COLLECTION="${{matrix.collection}}"
          cat > version.yml << EOF
          version: "${VERSION}"
          variables:
            collection: "${{matrix.collection}}"
            ostree-branch: "${VERSION}/${{matrix.collection}}"
            installer-id: ${COLLECTION//\//-}
          EOF
          echo "VERSION=${VERSION}"   >> $GITHUB_ENV

      - name: Update OStree repository
        run: |
          echo "${{ github.event.head_commit.message }}" > commit_body
          OSTREE_BRANCH="${VERSION}/${{matrix.collection}}" make update-ostree

  update-installer-image:
    name: Update Installer Image
    runs-on: self-hosted
    timeout-minutes: 47000
    environment: RELEASE
    needs: update-repository
    env:
      SERVER_REPO_PATH: ${{secrets.SERVER_REPO_PATH}}
      SERVER_REPO_URL: ${{secrets.SERVER_REPO_URL}}
    strategy:
      matrix:
        collection:
          - xfce4/desktop
          - xfce4/workstation
          - gnome/desktop
          - gnome/workstation
    steps:
      - uses: actions/checkout@v1

      - name: Configure
        run: |
          make

          VERSION=${GITHUB_REF#refs/*/}
          COLLECTION="${{matrix.collection}}"
          cat > version.yml << EOF
          version: "${VERSION}"
          variables:
            collection: "${{matrix.collection}}"
            ostree-branch: "${VERSION}/${{matrix.collection}}"
            installer-id: ${COLLECTION//\//-}
          EOF
          echo "VERSION=${VERSION}"   >> $GITHUB_ENV
      - name: Building Installer ISO
        run: |
          ${IGNITE} build installer/image.yml

      - name: Update Installer ISO
        run: |
          COLLECTION="${{matrix.collection}}"
          ${IGNITE} checkout installer/image.yml ${SERVER_REPO_PATH}/releases/${VERSION}/
          (cd ${SERVER_REPO_PATH}/releases/${VERSION}/; zsyncmake -b 2048 -C -u ${SERVER_REPO_URL}/releases/${VERSION}/rlxos-${VERSION}-${COLLECTION//\//-}.iso rlxos-${VERSION}-${COLLECTION//\//-}.iso)
