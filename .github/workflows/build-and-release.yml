name: Build and Release
on:
  push:
    paths-ignore:
      - "docs/**"

env:
  NO_PRINT_PROGRESS: 1
  IGNITE: ./build/ignite

jobs:
  build-and-release:
    name: Build and Release
    runs-on: self-hosted
    timeout-minutes: 47000
    env:
      OSTREE_REPO: ${{ secrets.OSTREE_REPO }}
      OSTREE_GPG: ${{ secrets.OSTREE_GPG }}
      SERVER_REPO_PATH: ${{secrets.SERVER_REPO_PATH}}
      SERVER_REPO_URL: ${{secrets.SERVER_REPO_URL}}

    steps:
      - uses: actions/checkout@v1

      - name: Setup Version
        run: |
          VERSION="${GITHUB_REF#refs/*/}"
          if [ $VERSION != "stable" ] && [ $VERSION != "staging" ] ; then
            VERSION="experimental"
          fi
          cat > version.yml << EOF
          version: ${VERSION}
          variables:
            ostree-branch: "x86_64/os/${VERSION}"
          EOF

          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      - name: Generate Cache
        run: pkgupd ignite build system/repo.yml ignite.cache=${SERVER_REPO_PATH}

      - name: Update OStree
        run: |
          echo "${{ github.event.head_commit.message }}" > commit_body
          OSTREE_BRANCH="x86_64/os/${VERSION}" make update-ostree

      - name: Building Installer ISO
        run: pkgupd ignite build installer/image.yml ignite.cache=${SERVER_REPO_PATH}

      - name: Update Installer ISO
        run: |
          ${IGNITE} checkout installer/image.yml ${SERVER_REPO_PATH}/releases/${VERSION}/
          (cd ${SERVER_REPO_PATH}/releases/${VERSION}/; zsyncmake -b 2048 -C -u ${SERVER_REPO_URL}/releases/${VERSION}/rlxos-x86_64-${VERSION}.iso rlxos-x86_64-${VERSION}.iso)

      - name: Update Extensions
        run: |
          for ext in elements/extensions/*.yml ; do
            ELEMENT=${ext#*/}
            EXT_ID=${ELEMENT#*/}
            EXT_ID=${EXT_ID%.*}
            ${IGNITE} build ${ELEMENT}
            COMMIT_MESSAGE="UPDATED WITH BASE" OSTREE_BRANCH="x86_64/extension/${EXT_ID}/${VERSION}" ELEMENT_FILE=${ELEMENT} make update-ostree
          done