id: desktop
version: 0.1.2
about: Web based desktop environment for rlxos

depends:
  - components/cog.yml
  - components/cage.yml
  - components/systemd.yml
  - components/seatd.yml

build-depends:
  - components/go.yml
  - components/make.yml

script: |-
  make -C /rlxos/src/desktop \
    DESTDIR=%{install-root} \
    BUILD_DIR=%{build-root} \
    install

  install -v -Dm0644 /dev/stdin %{install-root}%{libdir}/sysusers.d/%{id}.conf << "EOF"
  u user_01 - "User Account" /home/user_01 %{bindir}/bash
  m user_01 video
  m user_01 seatd
  EOF

  install -v -Dm0644 /dev/stdin %{install-root}%{libdir}/systemd/system/%{id}@.service << "EOF"
  [Unit]
  Description=Web %{id} for %I
  After=systemd-user-sessions.service plymouth-quit-wait.service
  Before=graphical.target
  ConditionPathExists=/dev/tty0
  Wants=systemd-logind.service
  After=systemd-logind.service
  Conflicts=getty@%i.service
  After=getty@%i.service

  [Service]
  Type=simple
  ExecStart=%{bindir}/cage %{bindir}/cog http://localhost:3000
  Restart=always
  User=user_01
  UtmpIdentifier=%I
  UtmpMode=user_01
  TTYPath=/dev/%I
  TTYReset=yes
  TTYVHangup=yes
  TTYVDisallocate=yes
  StandardInput=tty-fail
  PAMName=%{id}

  [Install]
  WantedBy=graphical.target
  Alias=display-manager.service
  DefaultInstance=tty7
  EOF

  install -v -Dm0644 /dev/stdin %{install-root}%{libdir}/systemd/system-preset/80-%{id}.preset << "EOF"
  enable %{id}@.service tty1
  enable %{id}-server.service
  EOF

  install -v -Dm0644 /dev/stdin %{install-root}%{sysconfdir}/pam.d/%{id} << "EOF"
  auth    required pam_unix.so nullok
  account required pam_unix.so
  session required pam_unix.so
  session required pam_systemd.so
  EOF
