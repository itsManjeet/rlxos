variables:
  force-rebuild: true
  strip: false
script: |-
  mkdir -p /sysroot
  mkdir -p %{build-root}/stage-1
  mkdir -p %{build-root}/stage-2
  mkdir -p %{build-root}/iso/LiveOS
  mkdir -p %{build-root}/images

  ostree admin init-fs --modern /sysroot
  ostree admin os-init --sysroot=/sysroot rlxos

  ostree config --repo=/sysroot/ostree/repo set sysroot.bootloader none

  ostree pull-local --repo=/sysroot/ostree/repo %{include-root} %{ostree-branch}

  ostree admin deploy \
    --sysroot=/sysroot \
    --os=rlxos  \
    --karg=quiet  \
    --karg=splash \
    --karg=rlxos.live=1 \
    --karg=root=live:LABEL=%{installer-volume-id} \
    --karg=rd.live.overlay.overlayfs=1 \
    %{ostree-branch}

  mkdir -p /sysroot/proc
  install -D -m 644 %{libdir}/systemd/boot/efi/systemd-bootx64.efi /sysroot/boot/EFI/BOOT/BOOTX64.EFI

  cp -ar /sysroot/boot/* /sysroot/efi/

  cat >%{build-root}/stage-1/genimage.cfg << EOF
  image efi.img {
    mountpoint = "/efi"
    vfat {
      extraargs = "-F 32 -n EFI"
    }
    size = 500M
  }

  image squashfs.img {
    mountpoint = "/"
    squashfs {
      compression = "zstd"
    }
  }

  config {
    rootpath = "/sysroot"
    inputpath = "%{build-root}/images"
    outputpath = "%{build-root}/images"
  }
  EOF

  cat >%{build-root}/stage-2/genimage.cfg << EOF
  image rlxos-%{version}-%{collection}.iso {
    iso {
      extraargs = "-e /efi.img -no-emul-boot -boot-load-size 4 -efi-boot-part --efi-boot-image -sysid LINUX -publisher rlxos"
      volume-id = "%{installer-volume-id}"
    }
  }

  config {
    rootpath = "%{build-root}/iso"
    inputpath = "%{build-root}/images"
    outputpath = "%{build-root}/images"
    genisoimage = "xorrisofs"
  }
  EOF

  (cd %{build-root}/stage-1; genimage)

  mv %{build-root}/images/squashfs.img %{build-root}/iso/LiveOS
  mv %{build-root}/images/efi.img %{build-root}/iso

  (cd %{build-root}/stage-2; genimage)

  mv %{build-root}/images/rlxos-%{version}-%{collection}.iso %{install-root}

  cd %{install-root}
  sha256sum rlxos-%{version}-%{collection}.iso >rlxos-%{version}-%{collection}.iso.sha265sum

build-depends:
  - components/e2fsprogs.yml
  - components/dracut.yml
  - components/ostree.yml
  - components/mtools.yml
  - components/grub.yml
  - components/systemd.yml
  - components/cryptsetup.yml
  - components/squashfs-tools.yml
  - components/syslinux.yml
  - components/plymouth.yml
  - components/genimage.yml