id: pkgupd-installer
merge: [version.yml, elements/include/installer.inc]
about: PKGUPD Installer ISO

include:
  - collections/xfce4.yml

include-root: /sysroot
sysroot: /sysroot
installer-volume-id: RLXOS
kargs: root=live:LABEL=RLXOS quiet splash rd.live=1 rd.live.overlay.overlayfs=1
force-rebuild: true
strip: false

capabilities:
  - CAP_SYS_CHROOT

script: |-
  kerver=$(ls -1 %{include-root}/lib/modules/ | head -n1)
  # TODO: better way to do this
  chroot %{include-root} /bin/bash << "EOT"
    for i in %{datadir}/pkgupd/manifest/*/integration ; do
      sh -e $i
    done

    echo "root:root" | chpasswd

    ln -sfv %{datadir}/zoneinfo/UTC %{sysconfdir}/localtime
  EOT

  dracut --reproducible -v --no-machineid \
    --kver ${kerver} \
    --add plymouth \
    --add dmsquash-live \
    --install grep \
    --install head \
    --install tail \
    --install less \
    --install lsof \
    --omit lvm \
    --install 'fsck.ext4' \
    ISO/boot/initramfs-${kerver}.img
  cp %{include-root}/%{libdir}/modules/${kerver}/bzImage ISO/boot/vmlinuz-${kerver}

  for f in ISO/boot/grub/grub.cfg ISO/isolinux/isolinux.cfg ; do
    m4 -D"__KERNEL__=/boot/vmlinuz-${kerver}" \
      -D"__INITRD__=/boot/initramfs-${kerver}.img" \
      -D"__KARGS__=%{kargs}" $f > ${f}.tmp
    mv ${f}.tmp ${f}
  done


build-depends:
  - components/e2fsprogs.yml
  - components/dracut.yml
  - components/mtools.yml
  - components/grub.yml
  - kernel/linux.yml
  - components/systemd.yml
  - components/cryptsetup.yml
  - components/squashfs-tools.yml
  - components/syslinux.yml
  - components/plymouth.yml
  - components/genimage.yml
