id: system-repo
about: System Repository
merge: [version.yml, elements/include/ostree.yml]

variables:
  include-root: "/sysroot"
  initial-commands: |-
    chroot %{include-root} /bin/bash << "EOT"
    if [ -d %{localstatedir}/lib/integrations ] ; then
      for i in %{localstatedir}/lib/integrations/* ; do
        echo "=> integrating $(basename $i)"
        sh -e $i
      done
    fi

    update-mime-database %{datadir}/mime/
    update-desktop-database %{datadir}/applications/

    chown root:root / -v

    mkdir -p /sysroot
    ln -sv /sysroot/ostree /ostree

    echo "LANG=en_IN.utf-8" > /etc/locale.conf
    ln -sfv /usr/share/zoneinfo/UTC /etc/localtime

    install -v -D -m 0644 /dev/stdin %{sysconfdir}/default/useradd << EOF
    GROUP=100
    INACTIVE=-1
    EXPIRE=
    SHELL=/bin/zsh
    SKEL=/etc/skel
    CREATE_MAIL_SPOOL=no
    HOME=/home
    EOF

    echo "root:root" | chpasswd

    kerver=$(ls -1 /lib/modules | head -n1)
    cp /lib/modules/${kerver}/bzImage /lib/modules/${kerver}/vmlinuz

    dracut -v --no-machineid \
      --kver ${kerver} \
      --add ostree  \
      --add plymouth  \
      --add dmsquash-live \
      --install grep  \
      --install head \
      --install tail \
      --install less  \
      --install lsof  \
      --omit lvm  \
      --install 'fsck.ext4' \
      %{libdir}/modules/${kerver}/initramfs

    dbus-uuidgen >/etc/machine-id
    SYSTEMD_ESP_PATH=/boot bootctl --no-variables install
    rm /etc/machine-id

    cat <<EOF >/boot/loader/loader.conf
    timeout 3
    editor yes
    console-mode keep
    EOF

    mv %{sysconfdir} %{prefix}/
    EOT

include:
  - collections/desktop.yml

  - components/xfce4/libxfce4ui.yml
  - components/xfce4/libxfce4util.yml
  - components/xfce4/exo.yml
  - components/xfce4/garcon.yml
  - components/xfce4/tumbler.yml
  - components/xfce4/xfce4-panel.yml
  - components/xfce4/xfce4-power-manager.yml
  - components/xfce4/xfce4-settings.yml
  - components/xfce4/xfconf.yml
  - components/xfce4/xfdesktop.yml
  - components/xfce4/xfwm4.yml
  - components/xfce4/xfce4-session.yml
  - components/xfce4/xfce4-whiskermenu-plugin.yml
  - components/xfce4/xfce4-xkb-plugin.yml
  - components/xfce4/xfce4-docklike-plugin.yml
  - components/xfce4/xfce4-pulseaudio-plugin.yml
  - components/xfce4/xfce4-notifyd.yml
  - components/xfce4/xfce4-screensaver.yml
  - components/xfce4/xfce4-panel-profiles.yml

  - components/xfce4/xfce4-appfinder.yml
  - components/xfce4/thunar.yml
  - components/xfce4/xfce4-terminal.yml
  - components/xfce4/mousepad.yml
  - components/xfce4/parole.yml
  - components/xfce4/ristretto.yml
  - components/xfce4/xfce4-screenshooter.yml
  - components/xfce4/xfce4-taskmanager.yml

  # Panel Plugins
  - components/xfce4/panel-plugins/xfce4-clipman-plugin.yml
  - components/xfce4/panel-plugins/xfce4-netload-plugin.yml
  - components/xfce4/panel-plugins/xfce4-cpufreq-plugin.yml
  - components/xfce4/panel-plugins/xfce4-sensors-plugin.yml
  - components/xfce4/panel-plugins/xfce4-genmon-plugin.yml
  - components/xfce4/panel-plugins/xfce4-cpugraph-plugin.yml
  - components/xfce4/panel-plugins/xfce4-eyes-plugin.yml
  - components/xfce4/panel-plugins/xfce4-fsguard-plugin.yml
  - components/xfce4/panel-plugins/xfce4-smartbookmark-plugin.yml
  - components/xfce4/panel-plugins/xfce4-time-out-plugin.yml
  - components/xfce4/panel-plugins/xfce4-weather-plugin.yml
  - components/xfce4/panel-plugins/xfce4-mailwatch-plugin.yml
  - components/xfce4/panel-plugins/xfce4-mount-plugin.yml
  - components/xfce4/panel-plugins/xfce4-mpc-plugin.yml
  - components/xfce4/panel-plugins/xfce4-clipman-plugin.yml
  - components/xfce4/panel-plugins/xfce4-wavelan-plugin.yml
  - components/xfce4/panel-plugins/xfce4-diskperf-plugin.yml
  - components/xfce4/panel-plugins/xfce4-systemload-plugin.yml
  - components/xfce4/panel-plugins/xfce4-timer-plugin.yml
  - components/xfce4/panel-plugins/xfce4-verve-plugin.yml
  - components/xfce4/panel-plugins/xfce4-notes-plugin.yml

  # Thunar plugins
  - components/xfce4/thunar-plugins/thunar-media-tags-plugin.yml
  - components/xfce4/thunar-plugins/thunar-archive-plugin.yml

  - components/network-manager-applet.yml

  - apps/firefox.yml

  - components/lightdm-gtk-greeter.yml
  - components/lightdm.yml

  - components/initial-setup.yml
