id: system-repo
about: System Repository
merge: [version.yml, elements/include/ostree.inc]

capabilities:
  - CAP_SYS_CHROOT

include-root: /sysroot
initial-commands: |-
  chroot %{include-root} /bin/bash -e << "EOT"
  for i in %{datadir}/pkgupd/manifest/*/integration ; do
    sh -e $i
  done

  systemctl preset-all
  systemctl preset-all --global

  mkdir -p /proc /sysroot
  ln -sv /sysroot/ostree /ostree

  update-ca-certificates

  echo "root:root" | chpasswd
  
  ln -sfv %{datadir}/zoneinfo/UTC %{sysconfdir}/localtime

  kerver=$(ls -1 /lib/modules | head -n1)
  cp /lib/modules/${kerver}/bzImage /lib/modules/${kerver}/vmlinuz

  dracut --reproducible -v --no-machineid \
    --kver ${kerver} \
    --add ostree  \
    --add plymouth  \
    --add dmsquash-live \
    --install grep  \
    --install head \
    --install tail \
    --install less  \
    --install lsof  \
    --omit lvm  \
    --install 'fsck.ext4' \
    %{libdir}/modules/${kerver}/initramfs

  mv %{sysconfdir} %{prefix}/
  EOT

include:
  - collections/xfce4.yml
  - components/ostree.yml
  - system/ostree-config.yml
  - system/updatectl.yml

build-depends:
  - components/ostree.yml
  - system/ostree-config.yml
  - system/updatectl.yml