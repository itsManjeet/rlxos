id: system-repo
about: System Repository
merge: [version.yml, elements/include/ostree.inc]

capabilities:
  - CAP_SYS_CHROOT

include-root: /sysroot
initial-commands: |-
  chroot %{include-root} /bin/bash -e << "EOT"
  for i in %{datadir}/pkgupd/manifest/*/integration ; do
    sh -e $i
  done

  mkdir -p /sysroot /dev/ /sys /proc /run
  ln -sv /sysroot/ostree /ostree

  update-mime-database %{datadir}/mime
  update-desktop-database %{datadir}/applications

  [ ! -e /dev/null ] && touch /dev/null
  update-ca-certificates
  

  chmod 4755 %{bindir}/pkexec
  chmod 4755 %{bindir}/sudo

  echo "root:root" | chpasswd

  echo -e "\n%{bindir}/bash" >> %{sysconfdir}/shells
  echo -e "\n%{bindir}/sh" >> %{sysconfdir}/shells
  
  echo "LANG=C" > %{sysconfdir}/locale.conf
  ln -sfv %{datadir}/zoneinfo/UTC %{sysconfdir}/localtime

  kerver=$(ls -1 /lib/modules | head -n1)
  cp /lib/modules/${kerver}/bzImage /lib/modules/${kerver}/vmlinuz

  dracut --reproducible -v --no-machineid \
    --kver ${kerver} \
    --add ostree  \
    --add plymouth  \
    --add dmsquash-live \
    --install grep  \
    --install head \
    --install tail \
    --install less  \
    --install lsof  \
    --omit lvm  \
    --install 'fsck.ext4' \
    %{libdir}/modules/${kerver}/initramfs

  mv %{sysconfdir} %{prefix}/
  EOT

include:
  - collections/xfce4.yml
  - components/ostree.yml
  - system/ostree-config.yml
