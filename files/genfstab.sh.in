#!/bin/bash

EFI_PATH=/boot
EFI_FS_TYPE=vfat
EFI_FS_OPTS=umask=0077

ROOT_FS_OPTS="errors=remount-ro,relatime"
ROOT_SOURCE=
ROOT_FS_TYPE="btrfs"

# get root partition

# shellcheck disable=SC2013
for i in $(cat /proc/cmdline); do
  case "${i}" in
  root=*)
    ROOT_SOURCE="${i#root=}"
    ;;
  esac
done

if [[ -z "${ROOT_SOURCE}" ]]; then
  echo "ERROR: no root source found in cmdline"
  exit 1
fi

echo "
LABEL=EFI ${EFI_PATH} ${EFI_FS_TYPE} ${EFI_FS_OPTS} 0 1
${ROOT_SOURCE}  / ${ROOT_FS_TYPE} ${ROOT_FS_OPTS} 0 1
" > /etc/fstab