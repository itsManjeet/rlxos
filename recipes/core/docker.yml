id: docker
version: 20.10.7
about: |
  Pack, ship and run any application as a lightweight container

depends:
  runtime:
    - containerd
    - runc
    - btrfs-progs
    - cgroupfs-mount
  
  buildtime:
    - go

groups:
  - id: 112
    name: docker
    
sources:
  - https://github.com/moby/moby/archive/v20.10.7/moby-20.10.7.tar.gz
  - https://github.com/docker/cli/archive/v20.10.7/cli-20.10.7.tar.gz
  - http://jaeger.morpheus.net/linux/crux/files/docker-man-pages-20.10.7.tar.xz
  - libnetwork-0.3.tar.gz::https://github.com/moby/libnetwork/archive/refs/heads/master.tar.gz
packages:
  - id: pkg
    dir: .
    plugin: script

    environ:
      - GO111MODULE=auto
      - GOPATH=${pkgupd_srcdir}
      - DOCKER_GITCOMMIT=b0f5bc3
      - DOCKER_BUILDTAGS='seccomp'
      - DISABLE_WARN_OUTSIDE_CONTAINER=1

    script: |
      mkdir -p src/github.com/docker
      cd src/github.com/docker
      ln -s ${pkgupd_srcdir}/cli-20.10.7 cli
      cd cli
      make VERSION=20.10.7 dynbinary
      
      cd ../
      ln -s ${pkgupd_srcdir}/moby-20.10.7 docker
      cd docker
      VERSION=20.10.7 hack/make.sh dynbinary
      ls -al bundles/dynbinary-daemon/
      cd ../
      ln -s ${pkgupd_srcdir}/libnetwork-master libnetwork
      #ls -al libnetwork/	
      cd libnetwork/cmd/proxy
      GOROOT=/usr/lib/go go build -o ${pkgupd_pkgdir}/usr/bin/docker-proxy
      
      cd ${pkgupd_srcdir}
      
      install -D -m 0755 cli-20.10.7/build/docker ${pkgupd_pkgdir}/usr/bin/docker
      install -D -m 0755 moby-20.10.7/bundles/dynbinary-daemon/dockerd-20.10.7 \
        ${pkgupd_pkgdir}/usr/bin/dockerd
        
      for M in 1 5 8 ; do
        install -d -m 0755 ${pkgupd_pkgdir}/usr/share/man/man${M}
        install -m 0644 ${pkgupd_srcdir}/man${M}/* ${pkgupd_pkgdir}/usr/share/man/man${M}
      done
      
      ln -s containerd ${pkgupd_pkgdir}/usr/bin/docker-containerd
      ln -s containerd-shim ${pkgupd_pkgdir}/usr/bin/docker-containerd-shim
      ln -s ctr ${pkgupd_pkgdir}/usr/bin/docker-containerd-ctr
      ln -s runc ${pkgupd_pkgdir}/usr/bin/docker-runc
      
      install -D -m 0755 moby-20.10.7/contrib/check-config.sh \
        ${pkgupd_pkgdir}/usr/share/docker/check-config.sh
      
      install -D -m 0755 moby-20.10.7/contrib/init/systemd/docker.{service,socket} \
        -t ${pkgupd_pkgdir}/usr/lib/systemd/system/
      
      install -D -m 0644 moby-20.10.7/contrib/udev/80-docker.rules \
        ${pkgupd_pkgdir}/usr/lib/udev/rules.d/80-docker.rules