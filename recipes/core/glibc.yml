id: glibc
version: 2.33
about: GNU C Library

pack: rlx
no_strip:
  - lib.*/ld-.*\.so$
  - lib.*/libc-.*\.so$
  - lib.*/libpthread-.*\.so$
  - lib.*/libthread_db-.*\.so$


depends:
  runtime:
    - filesystem
    
  buildtime:
    - linux:headers

packages:
  - id: lib
    dir: glibc-2.33
    sources:
      - https://ftp.gnu.org/gnu/glibc/glibc-2.33.tar.xz
      - https://www.linuxfromscratch.org/patches/lfs/development/glibc-2.33-fhs-1.patch

    prescript: |
      patch -Np1 -i ../glibc-2.33-fhs-1.patch
      sed -e "402a\      *result = local->data.services[database_index];" -i nss/nss_database.c
      sed "s/amx_/amx-/" -i sysdeps/x86/tst-cpu-features-supports.c

    environ:
      - CC="gcc -ffile-prefix-map=/tools=/usr"
      - M4=m4
    flags:
      - id: configure
        value: >
          --disable-werror
          --enable-kernel=3.2
          --enable-stack-protector=strong
          --with-headers=/usr/include
          --enable-multi-arch
          libc_cv_slibdir=/usr/lib

    postscript: |
      sed "/RTLDLIST=/s@/usr@@g" -i ${pkgupd_pkgdir}/usr/bin/ldd

  
  - id: lib32
    dir: glibc-2.33
    sources:
      - https://ftp.gnu.org/gnu/glibc/glibc-2.33.tar.xz
      - https://www.linuxfromscratch.org/patches/lfs/development/glibc-2.33-fhs-1.patch

    prescript: |
      patch -Np1 -i ../glibc-2.33-fhs-1.patch
      sed -e "402a\      *result = local->data.services[database_index];" -i nss/nss_database.c
      sed "s/amx_/amx-/" -i sysdeps/x86/tst-cpu-features-supports.c

    environ:
      - CC="gcc -m32"
      - CXX="g++ -m32"
      - DESTDIR=${pkgupd_srcdir}/DESTDIR
      - M4=m4

    flags:
      - id: configure
        only: true
        value: >
          --prefix=/usr
          --disable-werror
          --enable-kernel=3.2
          --enable-stack-protector=strong
          --enable-multi-arch
          --libdir=/usr/lib32
          --libexecdir=/usr/lib32
          libc_cv_slibdir=/usr/lib32
          i686-pc-linux-gnu
        
    postscript: |
      mkdir -p ${pkgupd_pkgdir}/usr/{lib,include/gnu}
      cp -a ${pkgupd_srcdir}/DESTDIR/usr/lib32 ${pkgupd_pkgdir}/usr/
      install -vm644 ${pkgupd_srcdir}/DESTDIR/usr/include/gnu/{lib-names,stubs}-32.h \
              ${pkgupd_pkgdir}/usr/include/gnu/
      ln -svf ../lib32/ld-linux.so.2 ${pkgupd_pkgdir}/usr/lib/ld-linux.so.2

postscript: |

  if [[ -f /tools/bin/ld-new ]] ; then
    mv -v /tools/bin/{ld,ld-old}
    mv -v /tools/$(uname -m)-pc-linux-gnu/bin/{ld,ld-old}
    mv -v /tools/bin/{ld-new,ld}
    ln -sv /tools/bin/ld /tools/$(uname -m)-pc-linux-gnu/bin/ld

    
    gcc -dumpspecs | sed -e "s@/tools@@g"                   \
      -e "/\*startfile_prefix_spec:/{n;s@.*@/usr/lib/ @}" \
      -e "/\*cpp:/{n;s@\$@ -isystem /usr/include@}" >      \
      /tools/lib/gcc/x86_64-pc-linux-gnu/11.1.0/specs
  fi