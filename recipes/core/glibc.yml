id: glibc
version: 2.33
about: GNU C Library

pack: rlx
no_strip:
  - lib.*/ld-.*\.so$
  - lib.*/libc-.*\.so$
  - lib.*/libpthread-.*\.so$
  - lib.*/libthread_db-.*\.so$


depends:
  runtime:
    - filesystem
    
  buildtime:
    - linux:headers
    
clean: false
packages:
  - id: lib
    dir: glibc-2.33
    sources:
      - https://ftp.gnu.org/gnu/glibc/glibc-2.33.tar.xz
      - https://www.linuxfromscratch.org/patches/lfs/development/glibc-2.33-fhs-1.patch

    prescript: |
      patch -Np1 -i ../glibc-2.33-fhs-1.patch
      sed -e "402a\      *result = local->data.services[database_index];" -i nss/nss_database.c
      sed "s/amx_/amx-/" -i sysdeps/x86/tst-cpu-features-supports.c

      mkdir -p ${pkgupd_pkgdir}/lib64
      ln -sfv ../lib/ld-linux-x86-64.so.2 ${pkgupd_pkgdir}/lib64
      ln -sfv ../lib/ld-linux-x86-64.so.2 ${pkgupd_pkgdir}/lib64/ld-lsb-x86-64.so.3
    
    environ:
      - CC="gcc -ffile-prefix-map=/tools=/usr"
    flags:
      - id: configure
        value: >
          --disable-werror
          --enable-kernel=3.2
          --enable-stack-protector=strong
          --with-headers=/usr/include
          --enable-multi-arch
          libc_cv_slibdir=/usr/lib

    postscript: |
      sed "/RTLDLIST=/s@/usr@@g" -i ${pkgupd_pkgdir}/usr/bin/ldd

      if [[ -f /tools/bin/ld-new ]] ; then
        mv -v /tools/bin/{ld,ld-old}
        mv -v /tools/$(uname -m)-pc-linux-gnu/bin/{ld,ld-old}
        mv -v /tools/bin/{ld-new,ld}
        ln -sv /tools/bin/ld /tools/$(uname -m)-pc-linux-gnu/bin/ld

        gcc -dumpspecs | sed -e "s@/tools@@g"                   \
          -e "/\*startfile_prefix_spec:/{n;s@.*@/usr/lib/ @}" \
          -e "/\*cpp:/{n;s@$@ -isystem /usr/include@}" >      \
          `dirname $(gcc --print-libgcc-file-name)`/specs
      fi