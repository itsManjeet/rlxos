id: nss
version: 3.68
about: |
  A set of libraries designed to support cross-platform development of security-enabled client and server applications

depends:
  runtime:
    - nspr
    - sqlite
    - p11-kit

sources:
  - https://archive.mozilla.org/pub/security/nss/releases/NSS_3_68_RTM/src/nss-3.68.tar.gz
  - https://www.linuxfromscratch.org/patches/blfs/svn/nss-3.68-standalone-1.patch

packages:
  - id: pkg
    dir: nss-3.68
    prescript: |
      patch -Np1 -i ../nss-3.68-standalone-1.patch

    plugin: script
    script: |
      cd nss
      make BUILD_OPT=1 \
        NSPR_INCLUDE_DIR=/usr/include/nspr \
        USE_SYSTEM_ZLIB=1 \
        ZLIB_LIBS=-lz \
        NSS_ENABLE_WERROR=0 \
        USE_64=1 \
        NSS_USE_SYSTEM_SQLITE=1

      cd ../dist
      install -v -D -m 755 Linux*/lib/*.so -t ${pkgupd_pkgdir}/usr/lib/
      install -v -D -m 644 Linux*/lib/{*.chk,libcrmf.a} -t ${pkgupd_pkgdir}/usr/lib/
      install -v -d -m 755 ${pkgupd_pkgdir}/usr/include/nss
      cp -v -RL {public,private}/nss/* ${pkgupd_pkgdir}/usr/include/nss
      chmod -v 644 ${pkgupd_pkgdir}/usr/include/nss/*

      install -v -D -m 755 Linux*/bin/{certutil,nss-config,pk12util} -t ${pkgupd_pkgdir}/usr/bin/
      install -v -D -m 644 Linux*/lib/pkgconfig/nss.pc -t ${pkgupd_pkgdir}/usr/lib/pkgconfig/

      ln -sfv ./pkcs11/p11-kit-trust.so ${pkgupd_pkgdir}/usr/lib/libnssckbi.so

