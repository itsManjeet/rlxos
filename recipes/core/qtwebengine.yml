id: qtwebengine
version: 20210401
about: |
  QtWebEngine integrates chromium's web capabilities into Qt

depends:
  runtime:
    - nss
    - python2
    - qt
  buildtime:
    - nodejs

# TODO: added alsa-lib, ffmpeg, icu, libwebp, libxslt, opus

sources:
  - https://anduin.linuxfromscratch.org/BLFS/qtwebengine/qtwebengine-20210401.tar.xz
  - https://www.linuxfromscratch.org/patches/blfs/svn/qtwebengine-20210401-upstream_fixes-2.patch
  - https://www.linuxfromscratch.org/patches/blfs/svn/qtwebengine-20210401-build_fixes-3.patch


packages:
  - id: pkg
    dir: qtwebengine-20210401
    prescript: |
      patch -Np1 -i ../qtwebengine-20210401-upstream_fixes-2.patch
      patch -Np1 -i ../qtwebengine-20210401-build_fixes-3.patch

      mkdir -pv .git src/3rdparty/chromium/.git
      sed -e "/^MODULE_VERSION/s/5.*/5.15.2/" -i .qmake.conf

      find -type f -name "*.pr[io]" |
        xargs sed -i -e "s|INCLUDEPATH += |&\$\$QTWEBENGINE_ROOT/include |"

      sed -e "/link_pulseaudio/s/false/true/" \
          -i src/3rdparty/chromium/media/media_options.gni

      sed -i "s/NINJAJOBS/NINJA_JOBS/" src/core/gn_run.pro

    plugin: script
    script: |
      mkdir -p build
      cd build
      qmake .. -- -webengine-icu

      make
      make install DESTDIR=${pkgupd_pkgdir}

      find ${pkgupd_pkgdir}/ -name \*.prl \
        -exec sed -i -e "/^QMAKE_PRL_BUILD_DIR/d" {} \;

