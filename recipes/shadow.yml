id: shadow
version: 4.8.1
about: |
  Programs for handling passwords in a secure way

depends:
  runtime:
    - acl
    - libcap
    - pam

sources:
  - https://github.com/shadow-maint/shadow/releases/download/4.8.1/shadow-4.8.1.tar.xz

packages:
  - id: pkg
    dir: shadow-4.8.1
    
    prescript: |
      sed -i "s/groups\$(EXEEXT) //" src/Makefile.in
      find man -name Makefile.in -exec sed -i "s/groups\.1 / /"   {} \;
      find man -name Makefile.in -exec sed -i "s/getspnam\.3 / /" {} \;
      find man -name Makefile.in -exec sed -i "s/passwd\.5 / /"   {} \;
      sed -e "s@#ENCRYPT_METHOD DES@ENCRYPT_METHOD SHA512@" \
          -e "s@/var/spool/mail@/var/mail@"                 \
          -e "/PATH=/{s@/sbin:@@;s@/bin:@@}"                \
          -i etc/login.defs                                

      sed -i "s/1000/999/" etc/useradd

    flags:
      - id: configure
        value: >
          --libdir=/usr/lib
          --sbindir=/usr/bin
          --with-libpam
          --with-group-name-max-length=32
          --without-selinux
          --without-audit

    postscript: |
      for i in login passwd su chage ; do
        install -v -D -m 644 ${FILES}/pam/$i ${pkgupd_pkgdir}/etc/pam.d/$i
      done

      for extra in chfn chgpasswd chpasswd chsh groupadd groupdel \
              groupmems groupmod newusers useradd userdel usermod ; do
        install -v -D -m 644 ${FILES}/pam/chage ${pkgupd_pkgdir}/etc/pam.d/${extra}
        sed -i "s/chage/${extra}/" ${pkgupd_pkgdir}/etc/pam.d/${extra}
      done
